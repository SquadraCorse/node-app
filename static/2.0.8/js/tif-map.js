var KLM=KLM||{};define(["v2/lib/lodash","tif/js/tif-img-responsive","tif/i18n","tif/constants","tif/js/tif-utils","v2/lib/text!tif/templates/destination-block-template.html"],function(e,t,n,r,i,s){KLM.tif=KLM.tif||{};var o=document,u=!1,a=!1,f,l,c,h,p,d=r.googleKey,v="//maps.googleapis.com/maps/api/js?v=3.exp&key="+d+"&sensor=false&callback=KLM.tif.mapInit",m,g=[],y=[],b=r.staticPath+"/img/map-view-marker.png",w=e.template(s),E="tif-map-marker",S=function(){a&&(p=l.toJSON(),x(),k())},x=function(){for(var e=0;e<g.length;e++)g[e].setMap(null);N(),window.google&&google.maps.event.clearInstanceListeners(m),g.length=0,y.length=0},T=function(e){var t=p[e],s={origin:f.get("origin"),pos:f.get("pos"),destination:t.destinationCode};t.linkMap={};for(var o=0;o<t.links.length;o++)t.linkMap[t.links[o].rel]=t.links[o].href;t.linkMap.flights&&(t.destinationUrl=i.rewriteUrl(t.linkMap.flights,s),t.destinationPriceUrl=i.rewriteUrl(t.linkMap.flights,s)),t.linkMap.overview&&(t.destinationUrl=i.rewriteUrl(t.linkMap.overview,s)),t.linkMap.calendar&&(t.destinationUrl=i.rewriteUrl(t.linkMap.calendar,s),t.destinationPriceUrl=i.rewriteUrl(t.linkMap.calendar,s)),t.contentEnriched&&(t.visualUrlSmall=t.visualUrlSmall||r.staticPath+"/img/destination-default-image.jpg",t.visualUrlMedium=t.visualUrlMedium||r.staticPath+"/img/destination-default-image.jpg");var u=w({data:t,i18n:n.labels}),a='<div class="'+E+'">'+u+"</div>";return a},N=function(){for(var e=0;e<y.length;e++)y[e]&&y[e].close()},C=function(e){N();if(!y[e]){var n=new google.maps.InfoWindow({content:T(e)});y[e]=n;var r=p[e].destinationCode,i=l.enrichDestinationsWithContent(null,r);i&&i.success(function(){p=l.toJSON();var t=T(e);y[e].setContent(t)}),google.maps.event.addListener(y[e],"domready",function(){t.crawl({container:"."+E})})}y[e].open(m,g[e])},k=function(){var e=p.length,t,n=function(e){google.maps.event.addListener(e,"click",function(){C(this.infoWindowIndex),c&&c.setAnimation(null),e.setAnimation(google.maps.Animation.BOUNCE),c=e})};if(e===1){var r=new google.maps.LatLng(p[0].coordinates.lat,p[0].coordinates.lon);t=new google.maps.LatLngBounds(r)}else t=new google.maps.LatLngBounds;for(var i=0;i<e;i++){var s=p[i],o=s.coordinates,u=s.destinationName+": "+s.minimumPrice.currency+" "+s.minimumPrice.displayPrice,a=new google.maps.LatLng(o.lat,o.lon),f={url:b,size:new google.maps.Size(32,32),anchor:new google.maps.Point(16,32)},l=new google.maps.Marker({position:a,map:m,title:u,infoWindowIndex:i,icon:f});e>1&&t.extend(a),n(l),g.push(l)}e!==1?m.fitBounds(t):m.setZoom(8),new google.maps.Rectangle({bounds:t,map:m,fillColor:"#000000",fillOpacity:.2,strokeWeight:0}),google.maps.event.addListenerOnce(m,"bounds_changed",function(){var e=this.getZoom();e<2&&(e=3),this.setZoom(e)})};KLM.tif.mapInit=function(){a=!0;var t=o.getElementById(h),n={center:new google.maps.LatLng(22.5,5.75),minZoom:2,maxZoom:13,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};m=new google.maps.Map(t,n),k()};var L=function(){x(),c=KLM.tif.mapInit=null},A=function(){l&&l.on("reset",S)},O=function(){l&&l.off("reset",S)},M=function(e){if(!u){u=!0,f=e.pageModel,h=e.container,l=e.collection,p=l.toJSON(),A();var t="script",n=o.createElement(t),r=o.getElementsByTagName(t)[0];n.src=v,r.parentNode.insertBefore(n,r)}else A(),S()};return{init:M,destroy:L,on:A,off:O}});